<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin | Barber Pro</title>
    
    <link rel="manifest" href="manifest-admin.json">
    
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root { --gold: #D4AF37; --bg: #0A0A0A; --card: #161616; --text: #FFF; --red: #ff4444; --green: #25D366; }
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Inter', sans-serif; }
        body { background: var(--bg); color: var(--text); padding-bottom: 90px; }
        .view { display: none; padding: 20px; }
        .active { display: block; }
        .glass-card { background: var(--card); border-radius: 15px; padding: 20px; border: 1px solid #222; margin-bottom: 15px; width: 100%; overflow: hidden; }
        h2 { color: var(--gold); margin-bottom: 15px; border-left: 4px solid var(--gold); padding-left: 10px; }
        
        input, select { 
            width: 100%; padding: 12px; background: #222; color: white; 
            border: 1px solid #333; border-radius: 8px; margin-top: 5px; 
            outline: none; font-size: 0.85rem; display: block;
        }

        input[type="date"] { padding-left: 8px; padding-right: 5px; width: calc(100% - 2px); }
        
        .grid-datas { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; width: 100%; margin-top: 10px; }
        .grid-datas label { font-size: 0.75rem; color: var(--gold); display: block; margin-bottom: 2px; }

        .btn-gold { background: var(--gold); color: #000; border: none; padding: 12px; border-radius: 8px; font-weight: bold; width: 100%; cursor: pointer; margin-top: 10px; }
        .slot-admin { background: #1a1a1a; border-radius: 12px; margin-bottom: 10px; border-left: 5px solid #444; padding: 15px; }
        .slot-ocupado { border-left-color: var(--gold); }
        .slot-bloqueado { border-left-color: var(--red); background: #221111; }
        .btn-whatsapp { background: var(--green); color: black; border: none; padding: 10px 15px; border-radius: 8px; font-weight: bold; text-decoration: none; display: flex; align-items: center; justify-content: center; gap: 5px; font-size: 0.85rem; width: 100%; margin-top: 10px; }
        .btn-lock { background: none; border: none; font-size: 1.2rem; cursor: pointer; color: white; }
        .btn-acao { background: none; border: 1px solid #333; color: white; padding: 8px 12px; border-radius: 8px; font-size: 0.8rem; cursor: pointer; flex: 1; text-align: center; }
        
        .btn-perfil-lista { background: rgba(212, 175, 55, 0.1); color: var(--gold); border: 1px solid var(--gold); padding: 8px 16px; border-radius: 8px; font-size: 0.85rem; font-weight: 600; cursor: pointer; transition: 0.3s; }

        nav { position: fixed; bottom: 0; width: 100%; background: #111; display: flex; height: 75px; border-top: 1px solid #222; z-index: 1000; }
        nav button { flex: 1; background: none; border: none; color: #555; font-weight: bold; font-size: 0.7rem; }
        nav button.active-btn { color: var(--gold); }
        .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .stat-box { background: #222; padding: 15px; border-radius: 10px; text-align: center; }
        .stat-box big { display: block; font-size: 1.4rem; color: var(--gold); font-weight: bold; }
        .dia-folga { padding: 12px; background: #222; border: 1px solid #333; border-radius: 8px; cursor: pointer; text-align: center; font-size: 0.8rem; }
        .dia-folga.active { background: var(--red); border-color: var(--red); }
        .switch { position: relative; display: inline-block; width: 50px; height: 24px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #444; transition: .4s; border-radius: 24px; }
        .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--green); }
        input:checked + .slider:before { transform: translateX(26px); }
        .row-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
    </style>
</head>
<body>
    <div id="view-login" class="view active">
        <h1 style="color:var(--gold); text-align:center; margin: 50px 0;">Admin Login</h1>
        <div class="glass-card">
            <select id="login-id">
                <option value="B1">Kevinho Barber</option>
                <option value="B2">Vinicius Barber</option>
            </select>
            <input type="password" id="login-pass" placeholder="Senha">
            <button class="btn-gold" onclick="fazerLogin()">ENTRAR</button>
        </div>
    </div>
    <div id="view-inicio" class="view">
        <h2 id="adm-nome">AGENDA</h2>
        <div id="status-remarcar" style="display:none; background:var(--gold); color:black; padding:5px; border-radius:5px; margin-bottom:10px; font-size:0.8rem; font-weight:bold; text-align:center;">MODO REMARCA√á√ÉO ATIVO</div>
        <input type="date" id="admin-date" onchange="carregarAgenda()">
        <div id="lista-agenda" style="margin-top:20px"></div>
    </div>
    <div id="view-clientes" class="view">
        <h2 id="titulo-clientes">Minha Carteira</h2>
        <input type="text" id="busca-cliente" placeholder="Buscar em meus clientes..." oninput="carregarClientes()">
        <div id="lista-clientes-geral" style="margin-top:20px"></div>
    </div>
    <div id="view-perfil-cliente" class="view">
        <button class="btn-acao" onclick="voltarPerfil()" style="margin-bottom:20px; flex:none;">‚Üê Voltar</button>
        <h2 id="p-nome" style="margin:0; border:none;">Nome Cliente</h2>
        <p id="p-tel" style="color:var(--gray); margin-bottom:20px;"></p>
        <div class="glass-card">
            <h4 style="color:var(--gold)">PLANO FIDELIDADE</h4>
            <div id="p-pontos" style="display:flex; flex-wrap:wrap; gap:8px; margin:15px 0;"></div>
            <div style="display:flex; gap:10px;">
                <button class="btn-gold" style="margin:0; flex:1;" onclick="ajustarPonto(1)">+ ADICIONAR</button>
                <button class="btn-gold" style="margin:0; flex:1; background:var(--red)" onclick="ajustarPonto(-1)">- REMOVER</button>
            </div>
        </div>
        <div class="glass-card">
            <h4>HIST√ìRICO DE CORTES</h4>
            <div id="p-historico" style="font-size:0.9rem; margin-top:10px;"></div>
        </div>
        <a id="p-zap" href="#" class="btn-whatsapp">Chamar no WhatsApp</a>
    </div>
    <div id="view-relatorios" class="view">
        <h2>Relat√≥rios</h2>
        <div class="glass-card">
            <select id="rel-tipo" onchange="gerarRelatorio()"><option value="diario">Di√°rio</option><option value="semanal">Semanal</option><option value="mensal">Mensal</option></select>
            <div class="stat-grid" style="margin:15px 0;">
                <div class="stat-box"><small>Atendimentos</small><big id="rel-total">0</big></div>
                <div class="stat-box"><small>Ocupa√ß√£o</small><big id="rel-perc">0%</big></div>
                <div class="stat-box"><small>Dispon√≠veis</small><big id="rel-disp">0</big></div>
                <div class="stat-box"><small>Cancelados</small><big id="rel-canc" style="color:var(--red)">0</big></div>
            </div>
            <button class="btn-gold" onclick="baixarPDF()">üì• EXPORTAR PDF COMPLETO</button>
        </div>
    </div>
    <div id="view-ajustes" class="view">
        <h2>Configura√ß√µes</h2>
        <div class="glass-card">
            <div class="row-header"><h3>MODO F√âRIAS</h3><label class="switch"><input type="checkbox" id="cfg-ferias-ativo" onchange="salvar('ferias')"><span class="slider"></span></label></div>
            <div class="grid-datas">
                <div><label>In√≠cio</label><input type="date" id="ferias-ini" onchange="salvar('ferias')"></div>
                <div><label>Fim</label><input type="date" id="ferias-fim" onchange="salvar('ferias')"></div>
            </div>
        </div>
        <div class="glass-card">
            <div class="row-header"><h3>PLANO FIDELIDADE</h3><label class="switch"><input type="checkbox" id="cfg-fidelidade-ativo" onchange="salvar('fidelidade')"><span class="slider"></span></label></div>
            <input type="number" id="cfg-fidelidade-meta" placeholder="Meta de selos">
            <input type="text" id="cfg-fidelidade-premio" placeholder="Pr√™mio (Ex: Corte Gr√°tis)">
            <button class="btn-gold" onclick="salvar('fidelidade')">SALVAR FIDELIDADE</button>
        </div>
        <div class="glass-card">
            <h3>FOLGAS SEMANAIS</h3>
            <div id="grid-folgas" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-top:10px;">
                <div class="dia-folga" onclick="toggleFolga(0)" data-dia="0">Dom</div>
                <div class="dia-folga" onclick="toggleFolga(1)" data-dia="1">Seg</div>
                <div class="dia-folga" onclick="toggleFolga(2)" data-dia="2">Ter</div>
                <div class="dia-folga" onclick="toggleFolga(3)" data-dia="3">Qua</div>
                <div class="dia-folga" onclick="toggleFolga(4)" data-dia="4">Qui</div>
                <div class="dia-folga" onclick="toggleFolga(5)" data-dia="5">Sex</div>
                <div class="dia-folga" onclick="toggleFolga(6)" data-dia="6">S√°b</div>
            </div>
        </div>
        <div class="glass-card"><h3>HOR√ÅRIO DE ATENDIMENTO</h3><div style="display:flex; gap:10px;"><input type="number" id="cfg-ini" placeholder="In√≠cio"><input type="number" id="cfg-fim" placeholder="Fim"></div><button class="btn-gold" onclick="salvar('atendimento')">SALVAR HOR√ÅRIO</button></div>
        <div class="glass-card"><h3>TEMPO DE CORTE (MINUTOS)</h3><input type="number" id="cfg-intervalo" placeholder="Tempo em minutos (Ex: 60)"><button class="btn-gold" onclick="salvar('tempo')">SALVAR TEMPO</button></div>
        <div class="glass-card"><h3>ALMO√áO / INTERVALO</h3><div style="display:flex; gap:10px;"><input type="number" id="cfg-almo-ini" placeholder="In√≠cio"><input type="number" id="cfg-almo-fim" placeholder="Fim"></div><button class="btn-gold" onclick="salvar('intervalo')">SALVAR ALMO√áO</button></div>
    </div>
    <nav id="nav-admin" style="display:none"><button id="nav-inicio" class="active-btn" onclick="mudarAba('inicio')">AGENDA</button><button id="nav-clientes" onclick="mudarAba('clientes')">CLIENTES</button><button id="nav-relatorios" onclick="mudarAba('relatorios')">RELAT√ìRIOS</button><button id="nav-ajustes" onclick="mudarAba('ajustes')">AJUSTES</button></nav>

<script>
    const firebaseConfig = { apiKey: "AIzaSyBbFcsmHNVMbfdhWZfb_p5qi0nebrAEUXE", authDomain: "agenda-barbearia-c2e3e.firebaseapp.com", databaseURL: "https://agenda-barbearia-c2e3e-default-rtdb.firebaseio.com", projectId: "agenda-barbearia-c2e3e", storageBucket: "agenda-barbearia-c2e3e.firebasestorage.app", messagingSenderId: "269186051650", appId: "1:269186051650:web:4f47ca696073c873fc47db" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    let bAtual = "", tempRemarcar = null, folgasLocais = [], pAberto = "", origemPerfil = "clientes", scrollPos = 0;

    function fazerLogin() { 
        const pass = document.getElementById('login-pass').value;
        const id = document.getElementById('login-id').value;
        if((id === "B1" && pass === "123") || (id === "B2" && pass === "321")) { 
            bAtual = id; 
            document.getElementById('view-login').style.display='none'; 
            document.getElementById('nav-admin').style.display='flex'; 
            document.getElementById('admin-date').value = new Date().toISOString().split('T')[0]; 
            document.getElementById('titulo-clientes').innerText = `Carteira: ${id === 'B1' ? 'Kevinho' : 'Vinicius'}`;
            mudarAba('inicio'); carregarConfig(); 
        } else alert("Senha Incorreta"); 
    }

    function mudarAba(aba) { 
        document.querySelectorAll('.view').forEach(v => v.classList.remove('active')); 
        document.querySelectorAll('nav button').forEach(b => b.classList.remove('active-btn')); 
        document.getElementById('view-'+aba).classList.add('active'); 
        if(document.getElementById('nav-'+aba)) document.getElementById('nav-'+aba).classList.add('active-btn'); 
        if(aba==='clientes') carregarClientes(); 
        if(aba==='inicio') carregarAgenda(); 
        if(aba==='relatorios') gerarRelatorio(); 
        window.scrollTo(0,0); 
    }

    async function carregarConfig() { 
        const snap = await db.ref(`config/${bAtual}`).once('value'); 
        const c = snap.val() || {inicio:8, fim:19, intervalo:60, folgas:[], almo√ßo_ini:12, almo√ßo_fim:13}; 
        document.getElementById('cfg-ini').value = c.inicio; 
        document.getElementById('cfg-fim').value = c.fim;
        document.getElementById('cfg-intervalo').value = c.intervalo || 60;
        document.getElementById('cfg-almo-ini').value = c.almo√ßo_ini; 
        document.getElementById('cfg-almo-fim').value = c.almo√ßo_fim;
        document.getElementById('ferias-ini').value = c.ferias_ini || ""; 
        document.getElementById('ferias-fim').value = c.ferias_fim || "";
        document.getElementById('cfg-ferias-ativo').checked = c.ferias_ativo || false;
        folgasLocais = c.folgas || []; 
        document.querySelectorAll('.dia-folga').forEach(el => { 
            el.classList.remove('active');
            if(folgasLocais.includes(parseInt(el.dataset.dia))) el.classList.add('active'); 
        });
        const sCamp = await db.ref(`config/campanha_fidelidade`).once('value'); 
        const camp = sCamp.val() || {ativo:true, meta:10, premio:"Corte Gr√°tis"};
        document.getElementById('cfg-fidelidade-meta').value = camp.meta; 
        document.getElementById('cfg-fidelidade-premio').value = camp.premio;
        document.getElementById('cfg-fidelidade-ativo').checked = camp.ativo || false;
    }

    async function carregarClientes() {
        const busca = document.getElementById('busca-cliente').value.toLowerCase();
        const lista = document.getElementById('lista-clientes-geral'); 
        lista.innerHTML = "<p style='text-align:center; color:var(--gold)'>Carregando sua carteira...</p>";
        
        let snapCarteira = await db.ref(`carteiras/${bAtual}`).once('value');
        let idsClientes = snapCarteira.val();

        if (!idsClientes) {
            const snapUsers = await db.ref(`usuarios`).once('value');
            const todosUsers = snapUsers.val() || {};
            let encontrouAlgum = false;
            for (let tel in todosUsers) {
                const links = todosUsers[tel].links || {};
                if (Object.keys(links).some(k => k.startsWith(bAtual))) {
                    await db.ref(`carteiras/${bAtual}/${tel}`).set(true);
                    encontrouAlgum = true;
                }
            }
            if (encontrouAlgum) {
                snapCarteira = await db.ref(`carteiras/${bAtual}`).once('value');
                idsClientes = snapCarteira.val();
            }
        }

        lista.innerHTML = "";
        if (!idsClientes) {
            lista.innerHTML = "<p style='text-align:center; padding:20px; color:gray;'>Nenhum cliente na sua carteira ainda.</p>";
            return;
        }

        for(let id in idsClientes) {
            const snapUser = await db.ref(`usuarios/${id}`).once('value');
            const u = snapUser.val();
            if(!u) continue;
            const p = u.perfil || {nome: "Cliente s/ Nome", tel: id};
            if(busca && !p.nome.toLowerCase().includes(busca) && !p.tel.includes(busca)) continue;
            
            lista.innerHTML += `
            <div class="glass-card" style="display:flex; justify-content:space-between; align-items:center;">
                <div><b style="font-size:1.1rem">${p.nome}</b><br><small style="color:var(--gray)">${p.tel}</small></div>
                <button class="btn-perfil-lista" onclick="abrirPerfil('${id}', 'clientes')">PERFIL</button>
            </div>`;
        }
    }

    function abrirPerfil(tel, vindoDe = "clientes") {
        origemPerfil = vindoDe; scrollPos = window.scrollY; pAberto = tel.replace(/\D/g,'');
        db.ref(`usuarios/${pAberto}`).once('value', s => {
            const u = s.val(); if(!u) return;
            document.getElementById('p-nome').innerText = u.perfil.nome;
            document.getElementById('p-tel').innerText = u.perfil.tel;
            document.getElementById('p-zap').href = `https://wa.me/55${pAberto}`;
            db.ref(`config/campanha_fidelidade`).once('value', sc => {
                const meta = sc.val().meta || 10; const pts = u.pontos || 0; 
                const cont = document.getElementById('p-pontos'); cont.innerHTML = "";
                for(let i=1; i<=meta; i++){
                    let d = document.createElement('div');
                    d.style = `width:30px; height:30px; border-radius:50%; border:2px solid ${i<=pts?'var(--gold)':'#444'}; background:${i<=pts?'var(--gold)':'none'}`;
                    cont.appendChild(d);
                }
            });
            const hist = document.getElementById('p-historico'); hist.innerHTML = "";
            let links = u.links || {};
            for(let path in links){
                if(path.startsWith(bAtual)){
                    const p = path.split('_'); 
                    hist.innerHTML += `<div style="padding:10px; border-bottom:1px solid #222; color:var(--gray)">üìÖ ${p[1].split('-').reverse().join('/')} √†s ${p[2].replace('h',':')}</div>`;
                }
            }
            if(hist.innerHTML === "") hist.innerHTML = "Nenhum corte registrado com voc√™.";
            mudarAba('perfil-cliente');
        });
    }

    function voltarPerfil() { mudarAba(origemPerfil); setTimeout(() => window.scrollTo(0, scrollPos), 50); }
    function ajustarPonto(val) { db.ref(`usuarios/${pAberto}/pontos`).transaction(p => Math.max(0, (p||0)+val)).then(() => abrirPerfil(pAberto, origemPerfil)); }

    function carregarAgenda() {
        const data = document.getElementById('admin-date').value;
        db.ref(`agendamentos/${bAtual}/${data}`).on('value', async snap => {
            const ags = snap.val() || {}, lista = document.getElementById('lista-agenda'); 
            const cfgSnap = await db.ref(`config/${bAtual}`).once('value');
            const cfg = cfgSnap.val() || {inicio:8, fim:19, intervalo:60};
            lista.innerHTML = "";
            for(let t = parseInt(cfg.inicio)*60; t < parseInt(cfg.fim)*60; t += parseInt(cfg.intervalo)) {
                let h = Math.floor(t/60), m = t%60, hora = `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}`, key = hora.replace(':','h'), it = ags[key];
                if(h >= (cfg.almo√ßo_ini||12) && h < (cfg.almo√ßo_fim||13)) continue;
                const isBloqueado = it && it.nome === "üîí BLOQUEADO";
                lista.innerHTML += `<div class="slot-admin ${it ? (isBloqueado ? 'slot-bloqueado' : 'slot-ocupado') : ''}">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
                        <b style="font-size:1.1rem;">${hora}</b>
                        ${it ? (isBloqueado ? `<button class="btn-lock" onclick="desbloquear('${data}','${key}')">üîí</button>` : `
                        <div style="display:flex; gap:8px; flex:1; justify-content:flex-end; max-width:200px;">
                            <button class="btn-acao" onclick="prepararRemarcacao('${data}','${key}','${it.nome}','${it.tel}')">REMARCAR</button>
                            <button class="btn-acao" style="color:var(--red); border-color:var(--red)" onclick="cancelar('${data}','${key}')">CANCELAR</button>
                        </div>`) : `<button class="btn-lock" onclick="${tempRemarcar ? `confirmarRemarcacao('${data}','${key}')` : `bloquear('${data}','${key}')`}">${tempRemarcar?'‚úÖ':'üîì'}</button>`}
                    </div>
                    ${it && !isBloqueado ? `
                    <div onclick="abrirPerfil('${it.tel}', 'inicio')">
                        <div style="border-top:1px solid #333; padding-top:10px;">
                            <b style="font-size:1.1rem;">${it.nome}</b>
                            <div style="font-size:0.9rem; color:var(--gray); margin:4px 0">${it.tel}</div>
                        </div>
                        <a href="https://wa.me/55${it.tel.replace(/\D/g,'')}" class="btn-whatsapp">WhatsApp</a>
                    </div>` : ''}
                </div>`;
            }
        });
    }

    function bloquear(data, key) { if(confirm("Bloquear este hor√°rio?")) db.ref(`agendamentos/${bAtual}/${data}/${key}`).set({nome:"üîí BLOQUEADO", tel:""}); }
    function desbloquear(data, key) { db.ref(`agendamentos/${bAtual}/${data}/${key}`).remove(); }
    function toggleFolga(dia) { const idx = folgasLocais.indexOf(dia); if(idx > -1) folgasLocais.splice(idx,1); else folgasLocais.push(dia); document.querySelector(`[data-dia="${dia}"]`).classList.toggle('active'); db.ref(`config/${bAtual}/folgas`).set(folgasLocais); }
    
    function salvar(t) { 
        const ref = db.ref(`config/${bAtual}`);
        if(t==='atendimento') ref.update({ inicio: document.getElementById('cfg-ini').value, fim: document.getElementById('cfg-fim').value }); 
        if(t==='tempo') ref.update({ intervalo: parseInt(document.getElementById('cfg-intervalo').value) || 60 }); 
        if(t==='intervalo') ref.update({ almo√ßo_ini:document.getElementById('cfg-almo-ini').value, almo√ßo_fim:document.getElementById('cfg-almo-fim').value }); 
        if(t==='ferias') ref.update({ ferias_ini:document.getElementById('ferias-ini').value, ferias_fim:document.getElementById('ferias-fim').value, ferias_ativo:document.getElementById('cfg-ferias-ativo').checked });
        if(t==='fidelidade') db.ref(`config/campanha_fidelidade`).update({ ativo: document.getElementById('cfg-fidelidade-ativo').checked, meta: parseInt(document.getElementById('cfg-fidelidade-meta').value)||10, premio: document.getElementById('cfg-fidelidade-premio').value||"Brinde" });
        alert("Configura√ß√£o salva!"); 
    }

    function gerarRelatorio() {
        const tipo = document.getElementById('rel-tipo').value;
        db.ref(`agendamentos/${bAtual}`).once('value', s => {
            let atendimentos = 0, ags = s.val() || {}, hoje = new Date().toISOString().split('T')[0];
            for(let d in ags) {
                const dataAg = new Date(d); const dif = (new Date() - dataAg)/(1000*60*60*24);
                let check = false;
                if(tipo==='diario' && d===hoje) check = true;
                else if(tipo==='semanal' && dif<=7) check = true;
                else if(tipo==='mensal' && dif<=30) check = true;
                if(check) for(let h in ags[d]) if(ags[d][h] && ags[d][h].tel && ags[d][h].nome!=="üîí BLOQUEADO") atendimentos++;
            }
            document.getElementById('rel-total').innerText = atendimentos;
            const meta = (tipo==='diario'?10:(tipo==='semanal'?60:240));
            document.getElementById('rel-perc').innerText = Math.floor((atendimentos/meta)*100) + "%";
            document.getElementById('rel-disp').innerText = Math.max(0, meta - atendimentos);
        });
    }

    function baixarPDF() {
        const { jsPDF } = window.jspdf; const doc = new jsPDF();
        const tipo = document.getElementById('rel-tipo').value.toUpperCase();
        doc.setFontSize(18); doc.text(`BARBER PRO - PERFORMANCE`, 14, 20);
        doc.setFontSize(11); doc.text(`Profissional: ${bAtual} | Data: ${new Date().toLocaleDateString()}`, 14, 30);
        const data = [ ["M√©trica", "Valor"], ["Total Atendimentos", document.getElementById('rel-total').innerText], ["Taxa Ocupa√ß√£o", document.getElementById('rel-perc').innerText], ["Hor√°rios Livres", document.getElementById('rel-disp').innerText] ];
        doc.autoTable({ head: [data[0]], body: data.slice(1), startY: 40, theme: 'grid', headStyles: {fillColor: [212, 175, 55]} });
        doc.save(`Relatorio_${bAtual}_${tipo}.pdf`);
    }

    function prepararRemarcacao(d, k, n, t) { tempRemarcar = { dAntiga: d, kAntiga: k, n, t }; document.getElementById('status-remarcar').style.display='block'; mudarAba('inicio'); }
    
    function confirmarRemarcacao(nD, nK) { 
        let up = {}; const telLimpo = tempRemarcar.t.replace(/\D/g,'');
        const novaKeyLink = `${bAtual}_${nD}_${nK}`; const antigaKeyLink = `${bAtual}_${tempRemarcar.dAntiga}_${tempRemarcar.kAntiga}`;
        up[`agendamentos/${bAtual}/${tempRemarcar.dAntiga}/${tempRemarcar.kAntiga}`] = null;
        up[`usuarios/${telLimpo}/links/${antigaKeyLink}`] = null;
        up[`agendamentos/${bAtual}/${nD}/${nK}`] = { nome: tempRemarcar.n, tel: tempRemarcar.t, data: nD, hora: nK.replace('h',':'), bId: bAtual, bNome: (bAtual === 'B1' ? 'Kevinho Barber' : 'Vinicius Barber') };
        up[`usuarios/${telLimpo}/links/${novaKeyLink}`] = true;
        up[`carteiras/${bAtual}/${telLimpo}`] = true;
        db.ref().update(up).then(() => { 
            tempRemarcar = null; document.getElementById('status-remarcar').style.display='none'; 
            alert("Remarcado com sucesso!");
        }); 
    }
    
    function cancelar(d, k) { 
        if(confirm("Deseja excluir este agendamento?")) {
            db.ref(`agendamentos/${bAtual}/${d}/${k}`).once('value', snap => {
                const info = snap.val();
                if(info && info.tel) {
                    const telLimpo = info.tel.replace(/\D/g,'');
                    const linkKey = `${bAtual}_${d}_${k}`;
                    let up = {}; up[`agendamentos/${bAtual}/${d}/${k}`] = null; up[`usuarios/${telLimpo}/links/${linkKey}`] = null;
                    db.ref().update(up);
                } else db.ref(`agendamentos/${bAtual}/${d}/${k}`).remove();
            });
        }
    }
</script>
</body>
</html>
